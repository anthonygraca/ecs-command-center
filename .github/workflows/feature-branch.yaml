name: "Auto-Create Feature Branch"

on:
  issues:
    types: [labeled]

jobs:
  create-branch:
    if: github.event.label.name == 'in-progress'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Branch Name
        id: branch_name
        env:
          ISSUE_NUM: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # 1. Lowercase the title
          # 2. Replace spaces/symbols with hyphens
          # 3. Limit length to 50 chars
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed -e 's/[^a-zA-Z0-9]/-/g' | cut -c 1-50)

          # Final Format: feat/12-my-issue-title
          BRANCH_NAME="feat/$ISSUE_NUM-$CLEAN_TITLE"

          echo "Computed Branch Name: $BRANCH_NAME"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create Branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ steps.branch_name.outputs.name }}
        run: |
          # Check if branch exists to avoid failure
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists."
          else
            echo "Creating branch: $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME"
            git push origin "$BRANCH_NAME"
          fi

      - name: Comment on Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          BRANCH_NAME: ${{ steps.branch_name.outputs.name }}
        run: |
          gh issue comment "$ISSUE_URL" --body "ðŸš€ **Feature Branch Created!** <br/> I've started the branch for you: \`$BRANCH_NAME\` <br/> \`git fetch origin && git checkout $BRANCH_NAME\`"
