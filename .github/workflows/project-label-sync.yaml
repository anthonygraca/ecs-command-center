name: Reconcile Personal Project Labels
on:
  schedule:
    # Runs every hour (at minute 0) to save minutes on private repos
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  reconcile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        env:
          PROJECT_PAT: ${{ secrets.PROJECT_PAT }}
          # YOUR USERNAME HERE
          USER_NAME: "anthonygraca"
          # YOUR PROJECT NUMBER (Check URL: /users/anthonygraca/projects/1)
          PROJECT_NUMBER: 2
          TARGET_COLUMN: "In progress"
          LABEL_NAME: "in-progress"
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const { USER_NAME, PROJECT_NUMBER, TARGET_COLUMN, LABEL_NAME } = process.env;

            console.log(`Fetching Project #${PROJECT_NUMBER} for User: ${USER_NAME}...`);

            // 1. GraphQL Query for USER-owned project
            const projectQuery = `
              query($user: String!, $number: Int!) {
                user(login: $user) {
                  projectV2(number: $number) {
                    id
                    items(first: 100) {
                      nodes {
                        id
                        fieldValues(first: 8) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field { ... on ProjectV2FieldCommon { name } }
                            }
                          }
                        }
                        content {
                          ... on Issue {
                            id
                            number
                            repository { name, owner { login } }
                            labels(first: 20) { nodes { name } }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const data = await github.graphql(projectQuery, { 
              user: USER_NAME, 
              number: parseInt(PROJECT_NUMBER) 
            });

            // 2. Validate Data Return
            if (!data.user || !data.user.projectV2) {
              console.log("Error: Project not found. Check USER_NAME and PROJECT_NUMBER.");
              return;
            }

            const items = data.user.projectV2.items.nodes;

            // 3. Iterate and Reconcile
            for (const item of items) {
              // Skip draft items (no content) or PRs (different structure)
              if (!item.content || !item.content.number) continue;

              // Find Status
              const statusVal = item.fieldValues.nodes.find(f => f.field && f.field.name === "Status");
              const currentStatus = statusVal ? statusVal.name : "No Status";

              console.log(`Checking if status matches target column: we found current status is ${currentStatus}`);          

              // Logic: If Status matches Target, Ensure Label exists
              if (currentStatus === TARGET_COLUMN) {
                const hasLabel = item.content.labels.nodes.some(l => l.name === LABEL_NAME);
                console.log(`Checking if issue has target label: we found $(hasLabel)`);
                
                if (!hasLabel) {
                  console.log(`Issue #${item.content.number} is in '${TARGET_COLUMN}' but missing label. Adding...`);
                  
                  await github.rest.issues.addLabels({
                    owner: item.content.repository.owner.login,
                    repo: item.content.repository.name,
                    issue_number: item.content.number,
                    labels: [LABEL_NAME]
                  });
                }
              }
            }
