name: Reconcile Project Labels
on:
  schedule:
    # Run every 10 minutes
    - cron: "*/10 * * * *"
  workflow_dispatch: # Allows manual trigger for testing

jobs:
  reconcile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        env:
          PROJECT_PAT: ${{ secrets.PROJECT_PAT }}
          # Set your variables here
          ORG_NAME: "your-org-or-username"
          PROJECT_NUMBER: 1 # Get this from the URL: /projects/1
          TARGET_COLUMN: "In Progress"
          LABEL_NAME: "in-progress"
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const { ORG_NAME, PROJECT_NUMBER, TARGET_COLUMN, LABEL_NAME } = process.env;

            // 1. Get Project ID
            console.log(`Fetching Project #${PROJECT_NUMBER} for ${ORG_NAME}...`);
            const projectQuery = `
              query($org: String!, $number: Int!) {
                organization(login: $org) { # Change to 'user(login: $org)' if this is a personal project
                  projectV2(number: $number) {
                    id
                    items(first: 100) {
                      nodes {
                        id
                        fieldValues(first: 8) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field { ... on ProjectV2FieldCommon { name } }
                            }
                          }
                        }
                        content {
                          ... on Issue {
                            id
                            number
                            repository { name, owner { login } }
                            labels(first: 20) { nodes { name } }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            // Note: If this is a USER project, swap 'organization' for 'user' in the query above.
            const data = await github.graphql(projectQuery, { 
              org: ORG_NAME, 
              number: parseInt(PROJECT_NUMBER) 
            });

            // Handle response structure depending on User vs Org
            const project = data.organization ? data.organization.projectV2 : data.user.projectV2;
            const items = project.items.nodes;

            // 2. Iterate and Reconcile
            for (const item of items) {
              // Skip if not an issue
              if (!item.content || !item.content.number) continue;

              // Find Status
              const statusVal = item.fieldValues.nodes.find(f => f.field && f.field.name === "Status");
              const currentStatus = statusVal ? statusVal.name : "No Status";

              // Check if it matches target column
              if (currentStatus === TARGET_COLUMN) {
                const hasLabel = item.content.labels.nodes.some(l => l.name === LABEL_NAME);
                
                if (!hasLabel) {
                  console.log(`Issue #${item.content.number} is in '${TARGET_COLUMN}' but missing label. Adding...`);
                  await github.rest.issues.addLabels({
                    owner: item.content.repository.owner.login,
                    repo: item.content.repository.name,
                    issue_number: item.content.number,
                    labels: [LABEL_NAME]
                  });
                }
              }
            }
