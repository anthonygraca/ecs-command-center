name: Sync Project Status to Label
on:
  projects_v2_item:
    types: [edited]

jobs:
  sync-label:
    runs-on: ubuntu-latest
    steps:
      - name: Check Status and Add Label
        uses: actions/github-script@v7
        env:
          # We need a PAT to read Project V2 data
          GITHUB_TOKEN: ${{ secrets.PROJECT_PAT }}
        with:
          script: |
            // 1. Get the Node ID of the item that triggered the event
            const itemId = context.payload.projects_v2_item.node_id;

            // 2. Query the Project API to get the specific Field Value (Status)
            // We need to fetch the content (Issue) to get its repo/number info
            const query = `
              query($itemId: ID!) {
                node(id: $itemId) {
                  ... on ProjectV2Item {
                    content {
                      ... on Issue {
                        number
                        repository {
                          name
                          owner {
                            login
                          }
                        }
                      }
                    }
                    fieldValues(first: 8) {
                      nodes {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          field {
                            ... on ProjectV2FieldCommon {
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const data = await github.graphql(query, { itemId: itemId });
            const item = data.node;

            // Safety check: Ensure this item is actually an Issue (not a Draft)
            if (!item.content || !item.content.number) {
              console.log("Item is not an Issue. Skipping.");
              return;
            }

            // 3. Find the "Status" field
            const statusField = item.fieldValues.nodes.find(
              node => node.field && node.field.name === "Status"
            );

            if (!statusField) {
              console.log("No Status field found.");
              return;
            }

            const currentStatus = statusField.name;
            console.log(`Current Status: ${currentStatus}`);

            // 4. Logic: If Status is 'In Progress', add label
            // CONFIGURATION: Match your exact column name below
            const TARGET_STATUS = "In Progress"; 
            const LABEL_TO_ADD = "in-progress";

            if (currentStatus === TARGET_STATUS) {
              console.log(`Status matches '${TARGET_STATUS}'. Adding label...`);
              
              await github.rest.issues.addLabels({
                owner: item.content.repository.owner.login,
                repo: item.content.repository.name,
                issue_number: item.content.number,
                labels: [LABEL_TO_ADD]
              });
              
            } else {
              console.log("Status does not match target. No action taken.");
              // Optional: Remove label if moved OUT of In Progress?
              // You can add that logic here if desired.
            }
